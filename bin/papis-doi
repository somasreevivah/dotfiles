#! /usr/bin/env bash

log() {
  echo "$(basename $0)> $@"
}

if [[ $1 = "-h" ]]; then
  echo "Get pdf and bibtex from doi identificator"
  exit 0
fi

sciget=sciget.sh
doi2bib=doi2bib

pdf_output=output.pdf
doi="$1"
shift
log "Doi: ${doi}"
[[ -n $@ ]] && log "Other args: $@"

bibtex_file=$(mktemp)
log "Bibtex file  ${bibtex_file}"

${doi2bib} ${doi} > ${bibtex_file}

if [[ -z $(cat ${bibtex_file}) ]]; then
  log "No bibtex retrieved!"
  exit 1
fi

${sciget} ${doi}

if [[ ! $? = 0 ]]; then
  log "Something happened"
  exit 1
fi

set -x
papis ${PAPIS_VERBOSE} -l ${PAPIS_LIB} add ${pdf_output} --from-bibtex ${bibtex_file} $@ --edit --confirm
set +x
